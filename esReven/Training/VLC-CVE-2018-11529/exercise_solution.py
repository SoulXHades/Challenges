from IPython.display import HTML, display

import reven2  # noqa: F401
import reven2.preview.taint
import reven2.preview.windows as windows
from reven2.address import LinearAddress, LogicalAddress, LogicalAddressSegmentIndex, PhysicalAddress  # noqa: F401
from reven2.arch import x64 as regs  # noqa: F401
from reven2.preview.project_manager import ProjectManager
from reven2.preview.taint import Tainter
from reven2.types import * # For values like U64

import sys
sys.path.append("../")
import utils

pm = ProjectManager("http://reven:8880/")
utils.import_scenario(pm, "./scenario/vlc-exploit_ac6915e4-1995-4227-998c-62f59ad51120.zip")

# Let's connect first.
server = pm.get_server_by(name="vlc-exploit")
trace = server.trace

readfile_call_transition = trace.transition(3075973870) # 3075973870 is the trace ID we see when we are at the start of NtReadFile() execution
ctx = windows.Context(trace.context_before(3075973870))  # Fill with windows context, see the cookbook
hdl_value = ctx.read(regs.rcx, U64)  # Read rcx from previous context to get the handle's integer value. It should be 0xB48 as what we see in the CPU windows at Trace ID 3075973870
hdl_object = ctx.handle(hdl_value).object()  # Fetch the API's handle object from the value at the context
print(hdl_object)  # You will need to print the .object()

# Result: File object "\Device\HarddiskVolume2\Users\reven\Documents\poc.mkv" (lin:0xffffe000b7ee9380)
